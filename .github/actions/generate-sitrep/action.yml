name: 'Generate Sitrep'

description: 'Generates sitrep and badge JSON files using a Python script'

inputs:
  badge_label:
    description: 'Label for the badge'
    required: true
  exit_status_pattern:
    description: 'Glob pattern for exit status files'
    required: false
  metrics_log:
    description: 'Metrics log file'
    required: false
  badge_filename:
    description: 'Output badge filename'
    required: true
  sitrep_filename:
    description: 'Output sitrep filename'
    required: false
    default: 'sitrep.json'
  exit_status_summary_file:
    description: 'Summary message (overrides default)'
    required: false
  full_result_markdown:
    description: 'File(s) containing full result markdown'
    required: false
  total_tests:
    description: 'Total number of tests'
    required: false
  passed_tests:
    description: 'Number of passed tests'
    required: false
  failed_tests:
    description: 'Number of failed tests'
    required: false
  badge_message:
    description: 'Badge message (overrides default)'
    required: false
  badge_color:
    description: 'Badge color (overrides default)'
    required: false
outputs:
  STATUS:
    description: 'The status of the tests (success or failure)'
    value: ${{ steps.set-status.outputs.STATUS }}
  TOTAL_TESTS:
    description: 'Total number of tests'
    value: ${{ steps.set-status.outputs.TOTAL_TESTS}}

runs:
  using: 'composite'
  steps:
    - name: Run generate_sitrep.py
      shell: bash
      run: |
        python3 "$(dirname "$0")/generate_sitrep.py" \
          --badge_label "${{ inputs.badge_label }}" \
          ${{ inputs.exit_status_pattern && '--exit_status_pattern "' + inputs.exit_status_pattern + '"' || '' }} \
          ${{ inputs.metrics_log && '--metrics_log "' + inputs.metrics_log + '"' || '' }} \
          --badge_filename "${{ inputs.badge_filename }}" \
          --sitrep_filename "${{ inputs.sitrep_filename }}" \
          ${{ inputs.exit_status_summary_file && '--exit_status_summary_file "' + inputs.summary + '"' || '' }} \
          ${{ inputs.full_result_markdown && '--full_result_markdown "' + inputs.full_result_markdown + '"' || '' }} \
          ${{ inputs.total_tests && '--total_tests ' + inputs.total_tests || '' }} \
          ${{ inputs.passed_tests && '--passed_tests ' + inputs.passed_tests || '' }} \
          ${{ inputs.failed_tests && '--failed_tests ' + inputs.failed_tests || '' }} \
          ${{ inputs.badge_message && '--badge_message "' + inputs.badge_message + '"' || '' }} \
          ${{ inputs.badge_color && '--badge_color "' + inputs.badge_color + '"' || '' }}
      env:
        GITHUB_RUN_ID: ${{ github.run_id }}
