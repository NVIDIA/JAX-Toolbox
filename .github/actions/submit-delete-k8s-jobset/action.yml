name: Submit & Delete K8s JobSet
description: Submit and delete a K8s JobSet, monitoring until one pod terminates

inputs:
  jobset-name:
    description: The JobSet name
    required: true
  jobset-config-file:
    description: Path to the Kubernetes JobSet YAML
    required: true

runs:
  using: "composite"
  steps:
    - name: Submit and Delete Kubernetes JobSet
      uses: ./.github/actions/with-post-step
      with:
        main: |
          # Disable debug mode to prevent loop spam
          set +x
          TIMEOUT_JOBSET_CREATION=600s
          TIMEOUT_POD_START=600s
          INPUT_JOBSET_NAME=${{ inputs.jobset-name }}
          INPUT_JOBSET_CONFIG_FILE=${{ inputs.jobset-config-file }}

          echo "Submit K8s JobSet: ${INPUT_JOBSET_NAME}"
          kubectl apply -f "${INPUT_JOBSET_CONFIG_FILE}"

          # Wait for JobSet to be created
          kubectl wait --for=create jobset/${INPUT_JOBSET_NAME} --timeout=$TIMEOUT_JOBSET_CREATION

          echo "Waiting for pods to be created..."
          sleep 5

          # Wait for at least one pod to be ready
          echo "Waiting for pods to start..."
          kubectl wait --for=condition=Ready \
            --selector=jobset.sigs.k8s.io/jobset-name=${INPUT_JOBSET_NAME} \
            --timeout=$TIMEOUT_POD_START pod

          sleep 20

          # Get all pod names associated with this JobSet
          pods=$(kubectl get pods --selector=jobset.sigs.k8s.io/jobset-name=${INPUT_JOBSET_NAME} -o name)

          if [ -z "${pods}" ]; then
            echo "No pods found for JobSet ${INPUT_JOBSET_NAME}"
            exit 1
          fi

          echo "Found pods:"
          echo "${pods}"

          # Monitor pods until one terminates
          echo "Monitoring pods for termination..."

          while true; do
            # Get all pods with their status in JSON format
            pod_list=$(kubectl get pods \
                --selector=jobset.sigs.k8s.io/jobset-name=${INPUT_JOBSET_NAME} \
                -o json 2>/dev/null)

            if [ -z "${pod_list}" ] || ! echo "${pod_list}" | jq empty 2>/dev/null; then
              echo "Warning: Could not retrieve valid pod status, retrying..."
              sleep 5
              continue
            fi

            # Check if any pod has terminated successfully
            terminated_pod=$(echo "${pod_list}" | jq -r '
              .items[] |
              select(
                .status.containerStatuses // [] |
                any(.state.terminated)
              ) |
              .metadata.name
            ' | head -n 1)

            # Check for explicitly Failed pods
            failed_pods=$(echo "${pod_list}" | jq -r '
              .items[] |
              select(.status.phase == "Failed") |
              .metadata.name
            ')

            # --- SUCCESS CASE ---
            if [ -n "${terminated_pod}" ]; then
              echo "Pod ${terminated_pod} has terminated."

              # Get the exit code
              exit_code=$(echo "${pod_list}" | jq -r "
                .items[] |
                select(.metadata.name == \"${terminated_pod}\") |
                .status.containerStatuses[0].state.terminated.exitCode
              ")

              echo "Exit code: ${exit_code}"

              # PRINT LOGS FOR ALL PODS (Tail 100)
              echo "========================================================"
              echo "       FINAL LOGS (Last 100 lines per pod)              "
              echo "========================================================"

              # Refresh pod list just in case
              final_pods=$(kubectl get pods --selector=jobset.sigs.k8s.io/jobset-name=${INPUT_JOBSET_NAME} -o name)

              for p in $final_pods; do
                echo ""
                echo "--- Logs for $p ---"
                kubectl logs $p --all-containers=true --tail=100 || echo "Could not retrieve logs for $p"
              done
              echo "========================================================"

              if [ "${exit_code}" -ne 0 ]; then
                echo "Pod terminated with non-zero exit code"
                kubectl describe pod/${terminated_pod}
                exit 1
              fi

              echo "JobSet completed successfully."
              break
            fi

            # --- FAILURE CASE ---
            if [ -n "${failed_pods}" ]; then
              echo "Found failed pods: ${failed_pods}"

              echo "========================================================"
              echo "       DEBUG LOGS (Last 100 lines per failed pod)       "
              echo "========================================================"

              for pod in ${failed_pods}; do
                echo "Details for failed pod ${pod}:"
                kubectl describe pod/${pod}
                echo "--- Logs for $pod ---"
                kubectl logs ${pod} --all-containers=true --tail=100 || true
              done
              exit 1
            fi

            sleep 30
          done

        post: |
          echo "Deleting K8s JobSet: ${{ inputs.jobset-name }}"
          kubectl delete -f "${{ inputs.jobset-config-file }}" || true

          # Ensure all related resources are cleaned up
          kubectl delete pods --selector=jobset.sigs.k8s.io/jobset-name=${{ inputs.jobset-name }} --force --grace-period=0 || true
