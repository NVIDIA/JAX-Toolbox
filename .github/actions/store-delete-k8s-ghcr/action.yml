name: Store & Delete GHCR Token
description: Store and Delete the docker credentails for pulling from GHCR

outputs:
  token-name:
    description: Name of the K8s secret to delete
    value: ${{ steps.token.outputs.token-name }}

runs:
  using: "composite"
  steps:
    - name: Generate a UUID token 
      shell: bash 
      id: token
      run: | 
        K8S_SECRET_NAME="${RANDOM}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
        echo "token-name=${K8S_SECRET_NAME}" >> $GITHUB_OUTPUT
        echo "K8S_SECRET_NAME=${K8S_SECRET_NAME}" >> ${GITHUB_ENV}

    - name: Store and delete secret on Kubernetes cluster
      uses: ./.github/actions/with-post-step
      with: 
        main: | 
          kubectl create secret generic \
          ${K8S_SECRET_NAME} \
          --from-file=.dockerconfigjson=$HOME/.docker/config.json \
          --type=kubernetes.io/dockerconfigjson

        post: |
          kubectl delete secret ${K8S_SECRET_NAME}
