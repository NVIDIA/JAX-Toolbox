name: Submit & Delete K8s Job
description: Submit and delete a K8s job after its execution

inputs:
  job-name:
    description: The job name
    required: true
  job-config-file:
    description: Path to the Kubernetes job YAML
    required: true

runs:
  using: "composite"
  steps:
    - name: Submit and Delete Kubernetes job
      uses: ./.github/actions/with-post-step
      with: 
        main: |
          echo "Submit K8s job ${{ inputs.job-config-file }}" 
          kubectl apply -f "${{ inputs.job-config-file }}"
          
          # Wait for job to be created
          kubectl wait --for=create job/${{ inputs.job-name }} --timeout=60s
          
          # Wait for job to be unsuspended
          kubectl wait --for=jsonpath='{.spec.suspend}=false' job/${{ inputs.job-name }} --timeout=7200s
          
          # Wait for pods to be running
          kubectl wait --for=condition=Ready \
            --selector=batch.kubernetes.io/job-name=${{ inputs.job-name }} \
            --timeout=600s pod
          
          # Stream logs
          kubectl logs --all-containers=true --all-pods=true --follow job/${{ inputs.job-name }}
          
          # Wait for the job to be completed or timed out
          kubectl wait --for=condition=Complete job/"${{ inputs.job-name }}" --timeout=10800s || (echo "Job did not complete within 3 hours." && exit 1)
          echo "Job logs for ${{ inputs.job-name }}:"
          kubectl logs --all-containers=true --all-pods=true --follow job/"${{ inputs.job-name }}"

          # Check job status to see if it failed
          failures=$(kubectl get job/"${{ inputs.job-name }}" -o 'jsonpath={.status.failed}')
          failures="${failures:-0}"
          if [ "$failures" -gt 0 ]; then
            echo "Job had $failures failures"
            kubectl describe job/"${{ inputs.job-name }}"
            pods=$(kubectl get pods --selector=batch.kubernetes.io/job-name=${{ inputs.job-name }} -o name)
            if [ -n "$pods" ]; then
              kubectl describe $pods
            fi
            exit 1
          fi
        post: |
          echo "Deleting K8s job you just submitted..."
          kubectl delete -f "${{ inputs.job-config-file }}"
          post: |
            echo "Deleting K8s job: ${{ inputs.job-name }}"
            kubectl delete -f "${{ inputs.job-config-file }}"
