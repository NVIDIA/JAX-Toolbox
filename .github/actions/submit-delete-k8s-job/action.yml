name: Delete K8s Job
description: Cleans up the Job resource to avoid leaving pods behind.

inputs:
  job-name:
    description: The job name to delete
    required: true
  job-config-file:
    description: Path to the Kubernetes job YAML
    required: true


runs:
  using: "composite"
  steps:
    - name: Delete Kubernetes job
      uses: ./.github/actions/with-post-step 
      shell: bash
      with: 
        main: |
          echo "Submit K8s job" 
          kubectl apply -f "${{ inputs.job-config-file }}"
          # wait for the job to be created 
          kubectl wait --for=create job/${{ inputs.job-name }} --timeout=60s

          # wait for the 'spec.suspend' field to become false. Necessary for kueue
          kubectl wait --for=jsonpath='{.spec.suspend}=false' job/${{ inputs.job-name }} --timeout=7200s

          while [[ -n $(kubectl get pods --selector=batch.kubernetes.io/job-name=${{ inputs.job-name }} --output=jsonpath='{.items[?(@.status.phase == "Pending")].metadata.name}') ]]; do
            echo "Waiting for pods to start..."
            sleep 20
          done

          # stream the logs 
          kubectl logs --all-containers=true --all-pods=true --follow job/${{ inputs.job-name }}
        post: | 
          pods=$(kubectl get pods --selector=batch.kubernetes.io/job-name=${{ inputs.job-name }} -o jsonpath='{.items[*].metadata.name}')

          for pod in $pods; do 
            status=$(kubectl get pod "$pod" -o jsonpath='{.status.phase}' || true)
            echo "Pod: $pod, status: $status"
            if [ "$status" = "Running" ] || [ "$status" = "Pending" ]; then
              kubectl delete pod "$pod" --force --grace-period=0 || true
            fi
          done
          
          # make sure job is deleted
          kubectl delete job ${{ inputs.job-name }} --force --grace-period=0 || true 