name: ~test JAX, unit

on:
  workflow_call:
    inputs:
      JAX_IMAGE:
        type: string
        description: 'JAX image built by NVIDIA/JAX-Toolbox'
        required: true
        default: 'ghcr.io/nvidia/jax:latest'
    outputs:
      ARTIFACTS:
        description: 'Name of the unit test artifact for downstream workflows'
        value: ${{ jobs.unit-test.outputs.ARTIFACTS }}            

jobs:

  # runner:
  #   uses: ./.github/workflows/_runner_ondemand_slurm.yaml
  #   with:
  #     NAME: "A100-${{ github.run_id }}"
  #     LABELS: "A100:${{ github.run_id }}"
  #     TIME: "01:00:00"
  #   secrets: inherit

  unit-test:
    strategy:
      fail-fast: false
      matrix:
        GPU_ARCH: [V100, A100]
    # ensures A100 job lands on dedicated runner for this particular job
    # runs-on: [self-hosted, "${{ matrix.GPU_ARCH == 'A100' && format('{0}:{1}', matrix.GPU_ARCH, github.run_id) || matrix.GPU_ARCH }}"]
    runs-on: ubuntu-22.04
    env:
      ARTIFACTS: 'jax-unit-test-logs'
    outputs:
      ARTIFACTS: ${ARTIFACTS}
    steps:
      - name: Print environment variables
        run: env

      # - name: Print GPU information
      #   run: nvidia-smi  

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # - name: Pull JAX image
      #   shell: bash -x -e {0}
      #   run: |
      #     docker pull ${{ inputs.JAX_IMAGE }}

      # - name: Backend-independent tests
      #   shell: bash -x {0}
      #   run: |
      #     docker run --gpus all ${{ inputs.JAX_IMAGE }} test-jax.sh -b backend-independent | tee test-backend-independent.log

      # - name: GPU-specific tests
      #   shell: bash -x {0}
      #   run: |
      #     docker run --gpus all ${{ inputs.JAX_IMAGE }} test-jax.sh -b gpu | tee test-gpu.log

      - name: download existing artifact
        uses: dawidd6/action-download-artifact@v2.27.0
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          run_id: 6047993737
          name: jax-unit-test-logs-${{ matrix.GPU_ARCH }}        

      - name: Postprocessing
        shell: bash -x -e {0}
        run: |
          BADGE_LABEL='${{ matrix.GPU_ARCH }} Unit'

          errors=$((grep -c 'ERROR:' test-*.log || true))
          failed_tests=$(grep -c 'FAILED in' test-*.log || true)
          passed_tests=$(grep -c 'PASSED in' test-*.log || true)
          total_tests=$((failed_tests + passed_tests))

          if [[ ${errors} > 0 ]] || [[ ${total_tests} == 0 ]]; then
            BADGE_MESSAGE='error'
            BADGE_COLOR=red
            SUMMARY='JAX unit test on ${{ matrix.GPU_ARCH }} did not complete due to errors.'
          else
            BADGE_MESSAGE="${passed_tests}/${total_tests} passed"
            if [[ ${failed_tests} == 0 ]]; then
              BADGE_COLOR=brightgreen
            else
              BADGE_COLOR=yellow
            fi
            SUMMARY="JAX unit test on ${{ matrix.GPU_ARCH }}: $BADGE_MESSAGE"
          fi

          echo >> outputs.env << EOF
          SUMMARY="${SUMMARY}"
          BADGE_LABEL="${BADGE_LABEL}"
          BADGE_COLOR="${BADGE_COLOR}"
          BADGE_MESSAGE="${BADGE_MESSAGE}"
          EOF

      - name: Upload test logs
        uses: actions/upload-artifact@v3
        with:
          name: ${ARTIFACTS}-${{ matrix.GPU_ARCH }}
          path: |
            outputs.env
            test-backend-independent.log
            test-gpu.log
