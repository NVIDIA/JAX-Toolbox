name: ~test Rosetta

on:
  workflow_call:
    inputs:
      ROSETTA_IMAGE:
        type: string
        description: 'Rosetta image build by NVIDIA/JAX-Toolbox'
        required: true
        default: 'ghcr.io/nvidia/rosetta-t5x:latest'

jobs:
  rosetta-tests:
    strategy:
      matrix:
        MARKERS: ["", "-m integration"]
      fail-fast: false
    runs-on: [self-hosted, compute, V100]
    steps:
      - name: Print environment variables
        run: |
          env

      - name: Print GPU information
        run: nvidia-smi  

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: nvcr.io
          username: '$oauthtoken'
          password: ${{ secrets.NVCR_TOKEN }}

      - name: Pull Rosetta image
        shell: bash -x -e {0}
        run: |
          docker pull ${{ inputs.ROSETTA_IMAGE }}

      - name: Run Rosetta tests w/ docker
        shell: bash -x -e {0}
        run: |
          docker run --gpus all ${{ inputs.ROSETTA_IMAGE }} sh -c "pip install '/opt/rosetta[test]' && pytest /opt/rosetta ${{ matrix.MARKERS }}"

