name: ~test core distribution logic

on:
  workflow_call:
    inputs:
      GIT_USER_NAME:
        type: string
        description: 'Username in GIT to perform git pull/push'
        required: false
        default: 'JAX Toolbox'
      GIT_USER_EMAIL:
        type: string
        description: 'User email in GIT to perform git pull/push'
        required: false
        default: 'jax@nvidia.com'
  workflow_dispatch:
    inputs:
      GIT_USER_NAME:
        type: string
        description: 'Username in GIT to perform git pull/push'
        required: false
        default: 'JAX Toolbox'
      GIT_USER_EMAIL:
        type: string
        description: 'User email in GIT to perform git pull/push'
        required: false
        default: 'jax@nvidia.com'


jobs:
  test-create-distribution:
    strategy:
      matrix:
        TEST_SCRIPT: ["extra-only-distribution.sh", "mirror-only-distribution.sh", "upstream-only-distribution.sh"]
      fail-fast: false
    runs-on: ubuntu-22.04
    steps:
      - name: Print environment variables
        run: env
      
      - name: Set git login for tests
        run: |
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"

      - name: Check out the repository under ${GITHUB_WORKSPACE}
        uses: actions/checkout@v3
      
      - name: Run integration test ${{ matrix.TEST_SCRIPT }}
        run: bash rosetta/tests/${{ matrix.TEST_SCRIPT }}