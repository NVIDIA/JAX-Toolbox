name: GKE test

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - synchronize
permissions:
  contents: write       # to fetch code and push branch
  actions:  write       # to cancel previous workflows
  packages: write       # to upload container
  pull-requests: write  # to make pull request for manifest bump

jobs:
  test:
    runs-on: gke-a3mega

    env:
      CLUSTER_NAME: jtb-30-05-2025
      GKE_VERSION: 1.31.6-gke.1221000 
      A3_MEGA: h100-mega-80gb-8
      DEFAULT_CPU_MACHINE: e2-standard-8
      NUM_NODES: 2
      ZONE: us-central1-a
      RESERVATION: jtb-reservation
      PROJECT: nv-jaxtoolboxgcp-20240925

    steps:
      - uses: actions/checkout@v4

      - name: Environment
        run: |
          set -x 
          
          gcloud version

          source $HOME/.venv/bin/activate
          python --version
          uv pip freeze

      - name: Apply xpk cluster create patch
        run: |
          cd $HOME/xpk && git checkout src/xpk/core/blueprint/blueprint_generator.py && cd -
          git apply --unsafe-paths .github/gke-workflow/xpk/blueprint.patch --directory $HOME/xpk 

      - name: Create cluster from compute reservation with xpk
        run: |
          set -x
          
          CLUSTER_EXISTS=$(gcloud container clusters list  --format=json | jq -r  'any(.[].name; . == "'$CLUSTER_NAME'")')
          
          if ! [ $CLUSTER_EXISTS = true  ]; then
            cd $HOME/xpk
            source $HOME/.venv/bin/activate
            python xpk.py cluster create \
                    --cluster $CLUSTER_NAME \
                    --gke-version $GKE_VERSION \
                    --device-type $A3_MEGA \
                    --num-nodes $NUM_NODES \
                    --default-pool-cpu-machine-type=$DEFAULT_CPU_MACHINE \
                    --project=$PROJECT \
                    --reservation $RESERVATION \
                    --zone $ZONE
          else
            echo "Cluster $CLUSTER_NAME already exists, skipping creation"  
          fi

      - name: Apply xpk workload create patch
        run: |
          cd $HOME/xpk && git checkout src/xpk/core && cd -
          git apply --unsafe-paths .github/gke-workflow/xpk/tcpxo_decorator.patch --directory $HOME/xpk 
          git apply --unsafe-paths .github/gke-workflow/xpk/docker_resources.patch --directory $HOME/xpk 
          git apply --unsafe-paths .github/gke-workflow/xpk/workflow.patch --directory $HOME/xpk 

      - name: Create maxtext workload
        env:
          WORKLOAD_NAME_PREFIX: maxtext
          IMAGE: ghcr.io/nvidia/jax-toolbox-internal:14690670611-maxtext-amd64
          DEVICE_TYPE: h100-mega-80gb-8
          IMAGE_PULL_SECRET: jax-toolbox-ghcr
          MAXTEXT_MODEL: llama2-7b 
          MAXTEXT_ATTENTION_TYPE: cudnn_flash_te
          MAXTEXT_REMAT_POLICY: minimal_flash
          MAXTEXT_TRAIN_STEPS: 20
          MAXTEXT_FSDP: 16
        run: |
          set -x
          WORKLOAD_NAME=${WORKLOAD_NAME_PREFIX}-${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}
          
          CMD="
              console=/dev/stdout;
              nsys-jax --capture-range=cudaProfilerApi 
                       --capture-range-end=stop 
                       -o /opt/output/profile.zip 
                       -- 
                       test-maxtext.sh -n $NUM_NODES 
                                       -b $NUM_NODES
                                       --model-name=$MAXTEXT_MODEL
                                       --attn-type=$MAXTEXT_ATTENTION_TYPE 
                                       --remat-policy=$MAXTEXT_REMAT_POLICY 
                                       --steps=$MAXTEXT_TRAIN_STEPS 
                                       --fsdp=$MAXTEXT_FSDP 
                                       --multiprocess 
                                       -a 'scan_layers=false
                                           max_target_length=4096 
                                           use_iota_embed=true 
                                           logits_dot_in_fp32=false 
                                           profiler=nsys 
                                           skip_first_n_steps_for_profiler=3 
                                           profiler_steps=8' |&
              tee /opt/output/output.$NODE_RANK.log > \${console}
          "

          # set container command in-line
          CMD=$(echo $CMD | sed 's/\n/\ /g')

          cd $HOME/xpk
          source $HOME/.venv/bin/activate
          python xpk.py workload create \
                        --cluster $CLUSTER_NAME \
                        --zone $ZONE \
                        --workload $WORKLOAD_NAME \
                        --docker-image $IMAGE \
                        --device-type $DEVICE_TYPE \
                        --num-nodes $NUM_NODES \
                        --num-slices $NUM_NODES \
                        --priority=high \
                        --scheduler=gke.io/topology-aware-auto \
                        --command "$CMD"

