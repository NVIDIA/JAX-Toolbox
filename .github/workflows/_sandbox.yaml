name: "~Sandbox"

on:
  workflow_dispatch:
  push:

permissions:
  contents: read  # to fetch code
  actions:  write # to cancel previous workflows
  packages: write # to upload container

jobs:

  build-base:
    uses: ./.github/workflows/_build_base.yaml
    with:
      ARCHITECTURE: amd64
    secrets: inherit

  build-jax:
    needs: [build-base]
    uses: ./.github/workflows/_build_jax.yaml
    with:
      ARCHITECTURE: amd64
    secrets: inherit

  build-pax:
    needs: [build-jax]
    uses: ./.github/workflows/_build_pax.yaml
    with:
      ARCHITECTURE: amd64
      BASE_IMAGE: ${{ needs.build-jax.outputs.DOCKER_TAG_MEALKIT }}
    secrets: inherit

  test-te:
    needs: [build-pax]
    uses: ./.github/workflows/_test_te.yaml
    with:
      TE_IMAGE: ${{ needs.build-pax.outputs.DOCKER_TAG_FINAL }}
    secrets: inherit

  build-rosetta:
    needs: [build-pax]
    uses: ./.github/workflows/_build_rosetta.yaml
    with:
      ARCHITECTURE: amd64
      BASE_LIBRARY: pax
      BASE_IMAGE: ${{ needs.build-pax.outputs.DOCKER_TAG_FINAL }}

  # test-pax:
  #   needs: [build-pax]
  #   uses: ./.github/workflows/_test_pax.yaml
  #   with:
  #     PAX_IMAGE: ${{ needs.build-pax.outputs.DOCKER_TAG_FINAL }}
  #   secrets: inherit

  # finalize:
  #   if: always()
  #   # TODO: use dynamic matrix to make dependencies self-updating
  #   needs: [build-jax, build-t5x, build-pax]
  #   uses: ./.github/workflows/_finalize.yaml
  #   with:
  #     PUBLISH_BADGE: false
  #   secrets: inherit
