name: "~Sandbox"

on:
  workflow_dispatch:
    inputs:
      ARCHITECTURE:
        type: choice
        description: 'Architecture to build for'
        required: true
        options:
          - amd64
          - arm64
      BUILD_DATE:
        type: string
        description: 'Date of the build'
        required: true
        default: '2024-03-04'

permissions:
  contents: read  # to fetch code
  actions:  write # to cancel previous workflows
  packages: write # to upload container

jobs:

  build-equinox:
    uses: ./.github/workflows/_build.yaml
    with:
      ARCHITECTURE: ${{ inputs.ARCHITECTURE }}
      ARTIFACT_NAME: artifact-equinox-build
      BADGE_FILENAME: badge-equinox-build
      BUILD_DATE: ${{ inputs.BUILD_DATE }}
      BASE_IMAGE: ghcr.io/nvidia/jax-mealkit:jax
      CONTAINER_NAME: equinox
      DOCKERFILE: .github/container/Dockerfile.equinox
    secrets: inherit

  test-equinox:
    needs: build-equinox
    if: inputs.ARCHITECTURE == 'amd64' # arm64 runners n/a
    uses: ./.github/workflows/_test_unit.yaml
    with:
      IMAGE: ${{ needs.build-equinox.outputs.DOCKER_TAG_FINAL }}
      TEST_NAME: equinox
      EXECUTE: |
        docker run --shm-size=1g --gpus all ${{ needs.build-equinox.outputs.DOCKER_TAG_FINAL }} \
        bash -exc -o pipefail \
        'pushd /opt/equinox/tests && pip install -r requirements.txt && pytest .' | tee test-equinox.log
      STATISTICS_SCRIPT: |
        errors=$(echo $summary_line | grep -oE '[0-9]+ error' | awk '{print $1} END { if (!NR) print 0}')
        failed_tests=$(echo $summary_line | grep -oE '[0-9]+ failed' | awk '{print $1} END { if (!NR) print 0}')
        passed_tests=$(echo $summary_line | grep -oE '[0-9]+ passed' | awk '{print $1} END { if (!NR) print 0}')
        total_tests=$((failed_tests + passed_tests))
        echo "TOTAL_TESTS=${total_tests}" >> $GITHUB_OUTPUT
        echo "ERRORS=${errors}" >> $GITHUB_OUTPUT
        echo "PASSED_TESTS=${passed_tests}" >> $GITHUB_OUTPUT
        echo "FAILED_TESTS=${failed_tests}" >> $GITHUB_OUTPUT
      ARTIFACTS: |
        test-equinox.log
    secrets: inherit
