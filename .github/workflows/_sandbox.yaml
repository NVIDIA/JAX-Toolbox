name: "~Sandbox"

on:
  push:

jobs:
  publish-badge:
    runs-on: ubuntu-22.04
    env:
      # Name/bash regex for shields.io endpoint JSON files
      PUBLISH_BADGE_FILES: '.*badge.*.json'
    steps:
      - name: copy badge to primary Gist
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.NVJAX_GIST_TOKEN }}
          script: |
            const srcId = "140345f00efa243faea262999c459d31";
            const dstId = "${{ vars.MOCK_BADGE_ENDPOINT_GIST_ID }}";
            const { PUBLISH_BADGE_FILES } = process.env;

            // Fetch files from source gist
            const { data: srcData } = await github.rest.gists.get({
              gist_id: srcId
            });

            // Fetch existing files from destination gist
            const { data: dstData } = await github.rest.gists.get({
              gist_id: dstId
            });

            // Mark existing files in destination gist for deletion
            let filesToUpdate = {};
            for (const filename of Object.keys(dstData.files)) {
              filesToUpdate[filename] = null;
            }

            // Add or update files based on the pattern
            const pattern = new RegExp(`${PUBLISH_BADGE_FILES}`);
            for (const [filename, fileObj] of Object.entries(srcData.files)) {
              if (filename.match(pattern)) {
                filesToUpdate[filename] = {
                  content: fileObj.content
                };
              }
            }

            // Update files in destination gist
            await github.rest.gists.update({
              gist_id: dstId,
              files: filesToUpdate
            });
            console.log("Files copied successfully.");
            console.log(Object.keys(filesToUpdate));
