name: "~Sandbox"

on:
  workflow_dispatch:

jobs:
  te-multi-gpu:
    uses: ./.github/workflows/_test_slurm_pyxis.yaml
    strategy:
      matrix:
        GPU: [A100, H100]
        N_GPU: [2] #, 4, 8]
      fail-fast: false
    secrets: inherit
    with:
      NAME: ${{ inputs.ARTIFACT_PREFIX }}-${{ matrix.N_GPU }}GPU
      OUTPUT_MOUNTPOINT: /output
      NODES: 1
      GPU_TYPE: ${{ matrix.GPU }}
      GPUS_PER_NODE: ${{ matrix.N_GPU }}
      NTASKS: 1
      NTASKS_PER_NODE: 1
      TIME_LIMIT: '00:10:00'
      EXTRA_EXPORTS: 'VOCAB_PATH=gs://t5-data/vocabs/cc_all.32000.100extra/sentencepiece.model'
      IMAGE: ghcr.io/nvidia/jax:jax-2024-10-25
      SRUN_PREAMBLE: |
        nvidia-smi
        pip install \
          pytest \
          pytest-reportlog \
          cuda-python \
          -r ${SRC_PATH_TRANSFORMER_ENGINE}/examples/jax/encoder/requirements.txt
      SRUN_SCRIPT: |
        set -ex
        cd ${SRC_PATH_TRANSFORMER_ENGINE}/examples/jax/encoder
        pytest --report-log=/output/pytest-report.jsonl \
          test_single_gpu_encoder.py \
          test_multigpu_encoder.py \
          test_model_parallel_encoder.py
