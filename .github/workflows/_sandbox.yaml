name: "~Sandbox"

on:
  workflow_dispatch:
    inputs:
      SOURCE_IMAGE_TAGS:
        type: string
        description: Space separated images to merge into a single manifest
        default: 'ghcr.io/nvidia/upstream-t5x:latest'
        required: true
      TARGET_IMAGE:
        type: string
        description: Target image without the tag to merge images into
        default: ghcr.io/nvidia/jax-toolbox-internal
        required: true

permissions:
  contents: read  # to fetch code
  actions:  write # to cancel previous workflows
  packages: write # to upload container

jobs:
  merge:
    runs-on: ubuntu-22.04
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set docker metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ inputs.TARGET_IMAGE }}
          flavor: |
            latest=false
          tags: |
            type=raw,value=${{ github.run_id }}-manual-merge

      - name: Combine images into a single multi-manifest image
        shell: bash -x -e {0}
        run: |
          docker buildx imagetools create ${{ inputs.SOURCE_IMAGE_TAGS }} --tag ${{ steps.meta.outputs.tags }}
      
      - name: Print into step summary
        shell: bash -x -e {0}
        run: |
          echo "# Image built" | tee -a $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" | tee -a $GITHUB_STEP_SUMMARY

