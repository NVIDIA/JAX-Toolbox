apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  name: PLACEHOLDER
spec:
  # Without this then the first few attempts to run the launcher will result in errors
  # due to failed DNS resolution of the worker names. It works eventually, given a big
  # enough backoffLimit, but it makes it harder to handle log-streaming and identifying
  # the "real" exit code of the job.
  launcherCreationPolicy: WaitForWorkersReady
  runPolicy:
    cleanPodPolicy: Running
    # surface errors direct to GitHub Actions without internal retries
    backoffLimit: 0
  # 1 MPI rank per GPU
  slotsPerWorker: 8
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      # Without this the launcher pod will be deleted on failure, which makes it hard
      # to provide useful diagnostics
      restartPolicy: Never
      template:
        spec:
          containers:
            - image: PLACEHOLDER
              imagePullPolicy: IfNotPresent
              name: PLACEHOLDER
              command:
                - mpirun
                - --allow-run-as-root
                - -np
                - "16"
                - -N
                - "8"
                - PLACEHOLDER
                - -b
                - "8"
                - -e
                - "16G"
                - -f
                - "2"
                - -g
                - "1"
                - -c
                - "1"
                - -n
                - "100"
          imagePullSecrets:
            - name: PLACEHOLDER
    Worker:
      replicas: 2
      template:
        spec:
          nodeSelector:
            node.kubernetes.io/instance-type: "p5.48xlarge"
          containers:
            - image: PLACEHOLDER
              imagePullPolicy: IfNotPresent
              name: PLACEHOLDER
              volumeMounts:
                - name: shmem
                  mountPath: /dev/shm
              resources:
                limits:
                  nvidia.com/gpu: 8
                  hugepages-2Mi: 5120Mi
                  vpc.amazonaws.com/efa: 32
                  memory: 32000Mi
          imagePullSecrets:
            - name: PLACEHOLDER
          volumes:
            - name: shmem
              hostPath:
                path: /dev/shm
