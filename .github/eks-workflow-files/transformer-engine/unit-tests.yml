apiVersion: batch/v1
kind: Job
metadata:
  labels:
    kueue.x-k8s.io/queue-name: p5-queue
  name: JOB_NAME
spec:
  activeDeadlineSeconds: 1200
  completions: 1
  parallelism: 1
  template:
    spec:
      containers:
      - name: transformer-engine
        env:
        - name: LOG_DIR
          value: /opt/output
        command:
        - bash
        - -xo
        - pipefail
        - -c
        - |
          pip install pytest-reportlog pytest-xdist

          # Start MPS daemon
          nvidia-cuda-mps-control -d

          # TE's default is slightly different, without the hyphen
          export TE_PATH=${SRC_PATH_TRANSFORMER_ENGINE}

          # 1 GPU per worker, 6 workers per GPU
          pytest-xdist.sh 1 6 pytest-report-L0-unittest.jsonl bash ${TE_PATH}/qa/L0_jax_unittest/test.sh | tee -a ${LOG_DIR}/tests.log

          touch /opt/output/done
        image: IMAGE_URI
        resources:
          limits:
            nvidia.com/gpu: 8
        volumeMounts:
        - mountPath: /opt/output
          name: output
      - name: upload-logs
        image: amazon/aws-cli
        env:
        - name: RUN_ID
          value: JOB_NAME
        - name: S3_BUCKET
          value: jax-toolbox-eks-output
        - name: CI_NAME
          value: transformer-engine
        command:
        - sh
        - -c
        - |
          while [ ! -f /opt/output/done ]; do
      	    sleep 5
          done

          # Upload to S3 bucket
          aws s3 cp /opt/output/summary.txt s3://${S3_BUCKET}/${CI_NAME}/${RUN_ID}/summary.txt

          # Upload logs to S3 bucket
          aws s3 cp /opt/output/ s3://${S3_BUCKET}/${CI_NAME}/${RUN_ID}/ --recursive --exclude "*" --include "*.log"
        volumeMounts:
        - name: output
          mountPath: /opt/output
      imagePullSecrets:
      - name: SECRETS_NAME
      restartPolicy: Never
      volumes:
      - name: output
