apiVersion: batch/v1
kind: Job
metadata:
    name: {{ JOB_NAME }}
    labels:
        kueue.x-k8s.io/queue-name: p5-queue
spec:
    # the job will run for 20 mins, as we can't set max_steps
    activeDeadlineSeconds: 1200
    completions: 1
    parallelism: 1
    template:
        spec:
            restartPolicy: Never
            containers:
                - name: transformer-engine
                  image: {{ IMAGE_URI }}
                  command:
                    - bash
                    - -xo
                    - pipefail
                    - -c
                    - |        
		      pip install pytest-reportlog pytest-xdist
		      # Start MPS daemon
		      nvidia-cuda-mps-control -d
		      # TE's default is slightly different, without the hyphen
		      export TE_PATH=${SRC_PATH_TRANSFORMER_ENGINE}
		      # 1 GPU per worker, 6 workers per GPU
		      pytest-xdist.sh 1 6 pytest-report-L0-unittest.jsonl bash ${TE_PATH}/qa/L0_jax_unittest/test.sh

                  resources:
                    limits:
                        nvidia.com/gpu: 8
                    requests:
                        nvidia.com/gpu: 1
                  volumeMounts:
                    - name: output
                      mountPath: /opt/output
            imagePullSecrets:
                - name: {{ IMAGE_PULL_SECRET }}
            volumes:
                - name: output
                  emptyDir: {}
