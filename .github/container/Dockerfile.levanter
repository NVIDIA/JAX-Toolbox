# syntax=docker/dockerfile:1-labs

ARG BASE_IMAGE=ghcr.io/nvidia/jax:mealkit
ARG REPO_LEVANTER=https://github.com/stanford-crfm/levanter.git
ARG REF_LEVANTER=main
ARG SRC_PATH_LEVANTER=/opt/levanter

###############################################################################
## Download source and add auxiliary scripts
###############################################################################

FROM ${BASE_IMAGE} as mealkit

ARG REPO_LEVANTER
ARG REF_LEVANTER
ARG SRC_PATH_LEVANTER

RUN <<"EOF" bash -ex
echo "levanter:
  url: https://github.com/stanford-crfm/levanter.git
  tracking_ref: main 
  latest_verified_commit: 3dda2c174b82de9c4b631e5dfdcc2d035f2b602f
  mode: git-clone
haliax:
  url: https://github.com/stanford-crfm/haliax.git
  tracking_ref: main
  latest_verified_commit: 0f29c95eea05ed9e2d9d01c7ae48f4231cf1a57d
  mode: git-clone" >> ${MANIFEST_FILE}
cat ${MANIFEST_FILE}
get-source.sh -l levanter -m ${MANIFEST_FILE} 
echo "-e file://${SRC_PATH_LEVANTER}" >> /opt/pip-tools.d/requirements-levanter.in
EOF

###############################################################################
## Install accumulated packages from the base image and the previous stage
###############################################################################

FROM mealkit as final

RUN pip-finalize.sh

RUN python -m levanter.main.cache_dataset --id dlwh/wikitext_103_detokenized --cache_dir cache/

WORKDIR ${SRC_PATH_LEVANTER}